# extreme
Task 7 - Extreme Obf
--------------------

This one was a bit trickier, and stumped me for a bit. Basically because opening it with jd-gui would result in obviously only partially parsed java files (perhaps entirely false java files, placed to confound jd-gui), and Krakatau would crash trying to decompile the jar file. In fact, jar files being just zip files, in theory I should have been able to abstract 'BasicStringObfuscation.jar' (yes it had the same name again) with just 7zip or what have you, but this would fail too: it was a corrupted zip file. But one which still worked fine if ran via `java -jar`?

I eventually figured out a way past this; my thinking was the file must be valid but padded or twisted in such a way it couldn't be treated as a normal zip. So I ran binwalk against it, which sure enough showed a fairly regular zip file and then some absurd padding and/or comments. `binwalk -e` got me the pure class files.

After this, Krakatau as before got me bytecode, and I could recompile this and run it just as in the last task. However the bytecode itself was heavily obfuscated: almost every third line would include a `goto` call, like so:

```text-plain
L324:   iconst_3 
L325:   bipush 95 
L327:   goto L331 

        .stack stack_1 Object java/lang/Throwable 
L330:   athrow 

        .stack full 
            locals Object [Ljava/lang/String; Object java/lang/String 
            stack Object java/io/PrintStream Integer Integer 
        .end stack 
L331:   invokestatic Method '1' a (II)Ljava/lang/String; 
L334:   goto L338 

        .stack stack_1 Object java/lang/Throwable 
L337:   athrow 

        .stack full 
            locals Object [Ljava/lang/String; Object java/lang/String 
            stack Object java/io/PrintStream Object java/lang/String 
        .end stack 
L338:   goto L342 
```

And function names were harder to understand, e.g. `invokestatic Method '1' a (II)Ljava/lang/String;` . However, what was lucky, is that the same principle applied - in the above snippet, you can see `L324: iconst_3` and `L325: bipush 95`, signifying a call to the string retriever. This only occurred six times in the massive byte code. Through trial and error, I was able to determine that `4, 42` was the 'please provide a password' string, and thus our target position, while `1, 77` retrieved the scrambled password. I put the password in the right position and got the scrambled characters, so I figured the overall function worked the same.

The next step was to find the function that served as the `c` function, the unscrambler of the password. This was a bit tricky: along with the gotos, there were plenty of stack frames, pointless xor operations and switches in the byte code to obscure what was happening. But, following from the original `1, 77`:

```text-plain
L162:   iconst_1 
L163:   bipush 77 
L165:   goto L169 
```

(original string specification)

```text-plain
L169:   invokestatic Method '1' a (II)Ljava/lang/String; 
L172:   goto L176 
```

(the above invoke static was equivalent to the `1.a` function from the previous task, and common across the other bipushes)

```text-plain
L176:   getstatic Field c '1' I 
L179:   ifle L187 
L182:   ldc 730770734 
L184:   goto L189 
```

(nonsense code)

```text-plain
L189:   ldc -1822908253 
L191:   ixor 
L192:   lookupswitch 
            -1193931379 : L187 
            -225155977 : L220 
            default : L426 
```

(more nonsense code - the other two branches aside from L220 were dead ends)

```text-plain
L220:   goto L224
```

```text-plain
L224:   invokestatic Method '0' c (Ljava/lang/String;)Ljava/lang/String; 
L227:   goto L231 
```

Finally. The above `invokestatic` was what I needed. Returning to the final bipush I had changed:

```text-plain
L353:   iconst_1 
L354:   bipush 77
L356:   goto L360 
```

```text-plain
L360:   invokestatic Method '1' a (II)Ljava/lang/String; 
L363:   goto L367 
```

I modified the above with

```text-plain
L360:   invokestatic Method '1' a (II)Ljava/lang/String; 
L361:   invokestatic Method '0' c (Ljava/lang/String;)Ljava/lang/String; 
L363:   goto L367
```

Recompiled and boom, I got the unscrambled password :)